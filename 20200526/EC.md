# 什么是执行上下文？

当js引擎解析到可执行代码时，会做一些执行前的准备工作，这就是执行上下文，也叫执行环境。

执行上下文为我们的可执行代码提供执行前的必要准备工作，例如变量对象定义，作用域链的扩展，提供调用者的对象引用等信息。

# ES3执行上下文

## 3种执行上下文类型

* 全局执行上下文：这是默认或者说是最基础的执行上下文，一个程序中只会存在一个全局上下文，全局上下文会生成一个全局对象，浏览器的window，nodejs的global，并且将this值绑定到这个全局对象上

* 函数执行上下文：每当一个函数被调用，都会创建一个函数执行上下文

* eval函数执行上下文：执行在eval函数内部的代码也会有属于自己的执行上下文。


## 执行上下文的内容

执行上下文是一个抽象概念，可以理解成一个object，包含

* 变量对象 variable object
* 活动对象 activation object
* 作用域链
* 调用者信息

### 变量对象

每个执行环境都有一个表示变量的对象——变量对象。全局环境的变量对象始终存在，而函数这样的局部环境，
只在函数执行过程中存在，在函数代码被调用且具体函数代码执行前，js引擎会用当前函数的参数列表初始化一个
变量对象，并将当前上下文与之关联，函数代码块中声明的变量和函数会作为属性添加到这个变量对象上。

### 活动对象

函数进入执行阶段，原本不能访问的变量对象被激活成一个活动对象，其实是一个东西，只是处于不同的阶段和状态。

### 作用域链

作用域规定了如何查找变量，确定了对变量的访问权限。查找变量时，会先从当前上下文的变量对象中找，如未找到，
就去父级的变量对象中找，一直到全局上下文的变量对象。这样由多个执行上下文的变量对象构成的链表就叫做作用域链。


### 当前可执行代码块的调用者 this

如果当前函数被作为对象方法调用或使用bind，apply，call等api进行委托调用时，则将当前代码块的调用者信息this value 存入当前执行上下文，否则默认位全局对象调用。

### 执行上下文数据结构表示

```
executionContext：{
    [variable object | activation object]：{
        arguments,
        variables: [...],
        functions: [...]
    },
    scope chain: variable object + all parents scopes
    thisValue: context object
}
```

## ES3执行上下文总结

1. 函数被调用
2. 在执行具体函数代码时，创建执行上下文
3. 进入执行上下文创建阶段
    1. 初始化作用域链
    2. 扫描arguments和所有的函数、变量声明，初始化一个变量对象
    3. 确定this值
4. 进入执行上下文执行阶段
    1. 在上下文中逐行运行代码，并在运行时分配变量值。


# ES5中的执行上下文

ES5 规范又对 ES3 中执行上下文的部分概念做了调整，最主要的调整，就是去除了 ES3 中变量对象和活动对象，以 词法环境组件（ LexicalEnvironment component） 和 变量环境组件（ VariableEnvironment component） 替代。所以 ES5 的

```
ExecutionContext = {
  ThisBinding = <this value>,
  LexicalEnvironment = { ... },
  VariableEnvironment = { ... },
}
```

1. 程序启动，全局上下文创建
    1. 创建词法环境
        1. 创建对象环境记录器，处理let和const定义的变量和函数
        2. 创建外部环境引用，值为null
    2. 创建变量环境
        1. 创建对象环境记录器，处理var定义的变量，初始值为undefined，造成变量提升
        2. 创建外部环境引用，值为null
    3. 确定this值为全局对象（浏览器为window）

2. 函数被调用，函数上下文创建
    1. 创建词法环境
        1. 创建声明式环境对象记录器，存储变量，函数和参数，包含了一个arguments对象和传递给函数的参数的length。负责处理let和const定义的变量
        2. 创建外部环境引用，值为全局对象或父级词法环境
    2. 创建变量环境
        1. 创建声明式环境对象记录器，存储变量，函数和参数，包含了一个arguments对象和传递给函数的参数的length。负责处理var定义的变量，初始值为undefined，造成变量提升。
        2. 创建外部环境引用，值为全局对象或父级词法环境
    3. 确定this的值

3. 进入执行上下文执行阶段
    1. 在上下文中逐行运行代码，并在运行时分配变量值。


## 执行上下文栈

当程序运行时，会调用很多函数，产生很多执行上下文，js引擎利用“执行上下文栈 ECS”来管理执行上下文。

栈遵循后进先出的特性，当代码执行时，首先会创建一个全局执行上下文压入栈底，全局执行上下文从创建到程序销毁都会存在栈底部，当函数调用时，创建一个新的函数执行上下文压入栈中，并将控制权交给该上下文，待执行完毕，该上下文从栈内弹出并销毁，并将控制权交还给栈内的上一个执行上下文。

栈的容量是有限制的，递归会造成栈溢出 stack overflow


# 总结

* 当函数运行时，会创建一个执行上下文，用于保存函数运行时需要的信息
* 所有的执行上下文都由执行上下文栈来管理，全局上下文位于栈底，每生成一个新的上下文对象，就压入栈中，栈有容量限制，
递归可能会造成栈溢出
* 执行上下文的内容包含作用域链，词法环境（处理let和const），变量环境(处理var)，this指向
* 变量环境创建时会造成变量提升
* 函数执行查找变量时，会先从本地执行环境找，如未找到，则去父级执行环境找，层层向上直到全局执行环境，找不到则返回undefined
* 一个函数能够访问到上层作用域，在函数创建的时候已经确定并保存到函数的[[scope]]属性中，和函数在哪里执行没有关系
* 一个函数的this执行，取决于调用者，call，apply，bind可以改变调用者
